<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>梆梆加固免费壳分析 | Simpson&#39;s Blog</title>
<meta name="keywords" content="梆梆加固, 检测">
<meta name="description" content="比较水水，很大部分是更着其他人的博客分析了一边其检测，关于解密和加载dex的部分没看">
<meta name="author" content="simpson">
<link rel="canonical" href="https://SimpsonGet.github.io/zh/posts/tech/bangbnagjiagu/">

 <link crossorigin="anonymous" href="/assets/css/stylesheet.36819bea596090d8b48cf10d9831382996197aa7e4fc86f792f7c08c9ca4d23b.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://SimpsonGet.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://SimpsonGet.github.io/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://SimpsonGet.github.io/img/logo.gif">
<link rel="apple-touch-icon" href="https://SimpsonGet.github.io/logo.gif">
<link rel="mask-icon" href="https://SimpsonGet.github.io/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://SimpsonGet.github.io/zh/posts/tech/bangbnagjiagu/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://SimpsonGet.github.io/zh/posts/tech/bangbnagjiagu/">
  <meta property="og:site_name" content="Simpson&#39;s Blog">
  <meta property="og:title" content="梆梆加固免费壳分析">
  <meta property="og:description" content="比较水水，很大部分是更着其他人的博客分析了一边其检测，关于解密和加载dex的部分没看">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-08T10:52:17+08:00">
    <meta property="article:modified_time" content="2025-07-08T10:52:17+08:00">
    <meta property="article:tag" content="Android">
    <meta property="article:tag" content="Shell">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="梆梆加固免费壳分析">
<meta name="twitter:description" content="比较水水，很大部分是更着其他人的博客分析了一边其检测，关于解密和加载dex的部分没看">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://SimpsonGet.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "https://SimpsonGet.github.io/zh/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "梆梆加固免费壳分析",
      "item": "https://SimpsonGet.github.io/zh/posts/tech/bangbnagjiagu/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "梆梆加固免费壳分析",
  "name": "梆梆加固免费壳分析",
  "description": "比较水水，很大部分是更着其他人的博客分析了一边其检测，关于解密和加载dex的部分没看",
  "keywords": [
    "梆梆加固", "检测"
  ],
  "articleBody": "\r样本：超星学习通[v6.5.9]\n包名：com.chaoxing.mobile\njava层分析 梆梆加固特征\n程序入口点\n根据系统架构选择\n在load()函数后，使用doAttach()利用反射的手段调用代码，那么libDexHelper.so即为对原始dex文件的释放\nnative层分析 so文件：libDexHelper.so\n直接打开apk中的so文件，可以发现so文件被加密\n获取解密后的so文件 dump解密so文件的时机\n博文给出的是在android_dlopen_ext时机\ndump的逻辑是修改目标段的读写执行权限，再将内存读到缓冲区，写入目标地址\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 function hook_dlopen(){ var soName = \"libDexHelper.so\" Interceptor.attach(Module.findExportByName(null, 'android_dlopen_ext'),{ onEnter : function(args){ //arg[0] 是要加载的so的路径 if(args[0] != null){ let loadPath = Memory.readUtf8String(args[0]) console.log(\"dlopen call is: \" + loadPath + \"\\n\") if (loadPath.includes(soName)){ this.flag = 1 } } },onLeave:function(retval){ console.log(\"dlopen return\\n\") if (this.flag === 1){ dumpSo(soName) this.flag = 0 } } }) } function dumpSo(filename){ var handle = Process.getModuleByName(filename) console.log(\"[dump] start dumping ---------\" + handle) var path = \"/data/data/com.chaoxing.mobile/\" + handle.name + \"_\" + handle.base + \"_\" + ptr(handle.size) + \".so\" var file_handle = new File(path, \"wb\") if(!file_handle){ console.log(\"[dump] dump failed\") return } Memory.protect(ptr(handle.base), handle.size, 'rwx') var libbuffer = ptr(handle.base).readByteArray(handle.size) file_handle.webkitRelativePath(libbuffer) file_handle.close() console.log(\"[dump] dump finished and path is: \" + path) } setImmediate(hook_dlopen) 内存中dump下来的so文件需要进行修复，这里使用sofixer修复\n1 2 3 4 5 sofixer -s soruce.so -o fix.so -m 0x0 -d -s 待修复的so路径 -o 修复后的so路径 -m 內存dump的基地址(16位) 0xABC -d 输出debug信息 修复后\n还有一些函数名被混淆，用idapython恢复为sub_offset\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import idautils import idc def rename_function(): for func_ea in idautils.Functions(): funcName = idc.get_func_name(func_ea) if funcName.startswith(\"pS\") or funcName.startswith(\"j_\") or funcName.startswith(\"p5\"): editName = f\"sub_{func_ea:X}\" else: continue if idc.set_name(func_ea, editName, idc.SN_NOWARN): print(f\"[Success] {funcName} ---\u003e {editName} in (0x{func_ea:X})\") rename_function() 分析 JNI_Onload中\n1 2 3 4 5 6 7 8 9 com/secneo/apkwrapper/H (Ljava/lang/String;)I (Ljava/lang/String;I)V (I)V (Ljava/lang/String;)Ljava/lang/String; d com/secneo/apkwrapper/AW ()V pn (Landroid/content/Context;Landroid/app/Application;)V hn sub_3199C函数集合了各种检测\n有很多跳板函数，需要结合0x71aeb83000内存加载地址去跳转\n0x430C0实现对 libc.so 中 read、open64、openat64等\t函数的 hook 或替换。\nsub_52BC4中\nlibc符号表恢复 一些thunk函数0x7254D05110其实是libc中的\nbase = 0x7254c9a000\n导出libc符号表 1 nm -D libc.so \u003e libc_symbols.txt 导入到libdexhelp中 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import idautils import ida_bytes import idc libc_base = 0x7254c9a000 # /proc/pid/maps/ 获得 libc_symbols = {} with open('./libc_symbols.txt', 'r') as f: for line in f: parts = line.strip().split() if len(parts) \u003e= 3: offset = int(parts[0], 16) name = parts[2].split('@@')[0] # 去掉版本号 libc_symbols[libc_base + offset] = name # 遍历当前段中的 qword for ea in idautils.Segments(): segname = idc.get_segm_name(ea) if '.data' in segname or '.got' in segname: start = idc.get_segm_start(ea) end = idc.get_segm_end(ea) for addr in range(start, end, 8): # 64位系统 if idc.is_qword(ida_bytes.get_full_flags(addr)): ptr_val = idc.get_qword(addr) if ptr_val in libc_symbols: name = f\"{libc_symbols[ptr_val]}_ptr\" idc.set_name(addr, name, idc.SN_CHECK) print(f\"[success] edit the {addr} ---\u003e {name}\") 【sub_52BC4】检测frida 1 2 3 4 5 6 7 //libc部分函数的参数及用法 sendto（int sockfd， const void *msg，int len , unsigned int flags， const struct sockaddr *to， int tolen） // recvfrom（int sockfd，void *buf，int len，unsigned int lags，struct sockaddr *from，int *fromlen // access(const char* pathname, int mode) //检查调用进程是否能对pathname指定的文件作mode操作，成功执行返回0，失败为-1 1 2 3 4 5 6 7 8 qword_EDE40 = GET/ws HTTP/1.1 Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: nmmA32Q10Aqj2vWK w== Sec-WebSocket-Version: 13 Host: 127.0.0.1:27042 1 2 3 4 5 v16[0] = 2; //这个赋值操作看起来像是设置某个协议族（family）。 在常见的网络编程中，AF_INET 的值是 2，表示 IPv4 地址族。因此，这可能是在初始化一个 sockaddr_in 结构体的第一个字段 sin_family。 v4 = 20000; 这个变量 v4 被设置为 20000。考虑到后续的操作，这个值很可能是用于设置端口号。 v16[1] = bswap32(v4) \u003e\u003e 16; 这里对 v4 进行了字节交换 (bswap32) 并右移 16 位。字节交换通常用于处理不同字节序之间的转换（例如，从主机字节序到网络字节序）。假设 bswap32(v4) 将 v4 的字节顺序反转，对于值 20000（即十六进制的 0x4E20），其字节交换后的结果仍然是 0x4E20（因为它是32位整数，且高位字节为零）。然后将其右移16位，得到的结果是 0x0000。 根据27042端口，即 本地的 Frida Server 默认监听端口\n1 2 3 4 这段代码的行为 用 AUTH\\r\\n 探测服务是否开启 发送标准 WebSocket 请求到 127.0.0.1:27042，分析是否返回 Sec-WebSocket-Accept，判断 WebSocket 是否被接受 如果成功，说明本地 Frida 正在运行，被识别 【sub_4CB6C】环境检测 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 xmmword_C4200 = [-2, -3, -1, -2, -3, -1, -2, -3, -1, -2, -3, -1, -2, -3, -1, -2] def v37_a(old, num): print(chr(ord(old) -num)) def common(oldstr): tmp = \"\" tmp2 = \"\" tmp += oldstr[0] if (len(oldstr) \u003e 16): tmp2 = oldstr[17::] for i in range(16): tmp += chr(ord(oldstr[i + 1]) + xmmword_C4200[i]) if (len(oldstr) \u003e 16): tmp += tmp2 return tmp def v37_1(): v37 = \"0uejp2/ersg2ed011pbiltm1ed\" a0uejp2Ersg2ed0 = \"0uejp2/ersg2ed011pbiltm1ed\" # a(a0uejp2Ersg2ed0[17], 3) # a(a0uejp2Ersg2ed0[18] ,1) # a(a0uejp2Ersg2ed0[19] , 2) # a(a0uejp2Ersg2ed0[20] , 3) # a(a0uejp2Ersg2ed0[21] , 1) # a(a0uejp2Ersg2ed0[22] , 2) # a(a0uejp2Ersg2ed0[23] , 3) # a(a0uejp2Ersg2ed0[24] , 1) # a(a0uejp2Ersg2ed0[25] , 2) v37 = \"/uejp2/ersg2ed011magisk.db\" v37 = common(v37) return v37 def v45_1(): v45 = \"0uejp2/ersg2nkusqr\" v45 = \"/uejp2/ersg2nkusqr\" v45 = common(v45) return v45 def v50_1(): v50 = \"0u|tvhn1ejp2ncjjuk\" v50 = \"/u|tvhn1ejp2ncjjuk\" v50 = common(v50) return v50 print(\"v37 === \",v37_1()) print(\"v45 === \",v45_1()) print(\"v50 === \",v50_1()) 1 2 3 4 5 6 /sbin/.core/db-0/magisk.db .core是使用的隐藏目录，包含其核心运行时数据。数据库存储设置和root权限 /sbin/.core/mirror\t是 Magisk 的一个关键功能 —— system-as-root 镜像挂载点\t/system/bin/magisk\t是主程序 /system/usr/we-need-root/ /system/bin/failsafe/ 通过一些字符串的拼接解密获得文件路径，然后使用access函数判断\n1、/sbin/.core/mirror\n2、/data/local/su\n3、/data/local/bin/su\n4、 /data/local/xbin/su\n5、/sbin/su\n6、/su/bin/su\n7、/system/bin/su\n8、/system/bin/.ext/su\n9、/system/bin/failsafe/su\n10、/system/sd/xbin/su\n11、/system/usr/we-need-root/su\n12、/system/xbin/su\n调用 openat 中断访问/proc/self/attr/prev文件获取数值与字符串u:r:zygote:s0比对调用\nSELinux 上下文（SELinux Context）检测，用于判断当前进程是否运行在预期的安全上下文中\n1 2 3 4 5 6 7 8 user:role:type:sensitivity u:r:zygote:s0 → zygote 进程的安全上下文 /proc/self/attr/prev 是什么？ 这是 SELinux 提供的一个接口文件，表示 当前进程的上一个安全上下文 正常情况下，App 是由 Zygote 启动的，它的 prev 上下文是 u:r:zygote:s0 如果修改了启动方式，比如通过 su 提权后再启动这个 App，那么 prev 上下文就会变成 u:r:su:s0 或其他非 zygote 上下文 ro.build.tags 主要用于标识构建类型如果检测到 test-keys 而不是 release-keys，则可能提示用户当前系统存在潜在的安全问题。\n【sub_52EA0】java层检测 1 2 3 4 5 int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine) (void *), void *arg); //\\3) void *(*start_routine) (void *)：以函数指针的方式指明新建线程需要执行的函数，该函数的参数最多有 1 个（可以省略不写），形参和返回值的类型都必须为 void* 类型。void* 类型又称空指针类型，表明指针所指数据的类型是未知的。使用此类型指针时，我们通常需要先对其进行强制类型转换，然后才能正常访问指针指向的数据。 根据pthread_create函数的使用方法得x2寄存器存放的sub_52EA0函数，其实是将要开启新线程执行的函数地址\n线程异步执行sub_52EA0\n这边需要根据汇编手动恢复该函数的签名（因为是thunk跳板函数所以ida没有自动识别），也可以使用idapython去做自动化批量设置\n1 j_execl_ptr(\"/system/bin/app_process\", \"/system/bin/app_process\", \"/system/bin\", “--nice-name=zygisk.so”, \"com.secneo.apkwrapper.H\", \"--write-fd\", v12, \"--flags\", 0, 0LL); so层通过excel对java层进行检测，检测tracepid\n​\t【sub_4D638】hook框架检测 太多了就恢复两个看看\nisExportFunctionExist是对目标so以绝对路径的方式\n通过mmap进行映射到maps中，与原来已经在maps的so在内存中的导出函数进行比对前16个字节，\n如果比对不一致则返回1，否则返回0，如果maps没有这个so则返回0，如果maps中有这个so但没有这个要搜索的导出函数则返回-1。\n通过对比libart.so中导出函数的前16字节判断是否被修改。\n检查环境变量 CLASSPATH 是否存在、是否非空、且是否长度大于等于 6。为了判断当前运行环境是否被注入、是否正确设置、是否伪装成功等。\n【sub_4E308】虚拟机检测 1 2 3 4 5 6 7 8 9 10 11 在Android开发中，可以通过c接口直接获取设备属性，系统接口为： int __system_property_get(const char* name, char* value)； j___system_property_get_ptr(\"ro.bluetooth.name\", a1) j___system_property_get_ptr(\"vmos.browser.home\", a1) j___system_property_get_ptr(\"vmprop.wifissid\", a1) j___system_property_get_ptr(\"ro.product.manufacturer\", a1) j___system_property_get_ptr(\"ro.product.model\", a1) j___system_property_get_ptr(\"ro.product.manufacturer\", a1) ueventd.ttVM_x86.rc、init.ttVM_x86.rc这些是 BlueStacks 虚拟机镜像文件，一般不会在真实设备中出现。\n判断这些文件是否存在且是普通文件，\t关键字判断等\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #其他博客的总结 调用 _system_property_get(\"ro.bluetooth.name\", resultAddr) ro.ip.name ro.product.manufacturer ro.product.model 这么四个属性对应的数值与\"vmos\"（\"vmos\"代表虚拟机）比较 调用 _system_property_get(\"vmos.browser.home\", resultAddr) vmos.camera.enable ro.vmos.simplest.rom persist.vmos.setting.show persist.vmos.tool.show 这么四个属性对应的数值与0x30作比较（满足一定的条件resultAddr会被自动赋值为0x30）比较，此处是比较不相同 调用 _system_property_get(\"vmprop.wifissid\", resultAddr) 调用 _system_property_get(\"persist.vmos.root.enable\", resultAddr) 调用 _system_property_get(\"persist.vmos.root.show\", resultAddr) persist.vmos.skills.show persist.vmos.xposed.enable persist.vmos.xposed.show ro.vmos.simplest.rom vmos.camera.enable 上述调用_system_property_get获取属性值之后，如果_system_property_get的返回值是否大于0 调用 access 访问 /system/priv-app/vmos-pro-intent 是否存在 fopen 打开 //proc/version.osed.show 文件，调用fgets获取文件内容，是否存在字符串\"titan\" fopen 打开 //property_contexts.show 文件，调用fgets获取文件内容，是否存在字符串\"titan\" fopen 打开 //service_contexts 文件，调用fgets获取文件内容，是否存在字符串\"titan\" 【sub_56C10】调试器检测 通过foepn 打开/proc/pid/status文件\n调用sleep(1)循环检查status文件检测“state”标志和\"TracerPid:“标志\n如果获取的pid不为0且跟调用getpid函数获取自身pid的不一致则调用中断 kill 关闭调试进程\n【解密DEX】 加密数据存放于最大的dex中，根据dexdata0定位\n每次申请0x20000大小循环解密\nsub_38E04\n三个参数分别是：被加密数据的地址、存放解密后数据的位置、参与解密运算的32字节密钥\n1 2 makeInMemoryDexElements 的核心作用是： 将内存中的 DEX 文件（或 ZIP/APK 中的 DEX）转换为 DexPathList 中的 Element 数组，供 ClassLoader 使用。 最后使用dexfile::loader加载解密后的dex文件\n参考文献 https://bbs.kanxue.com/thread-191649.htm\nhttps://zhuanlan.zhihu.com/p/685239153\nhttps://x2d1.github.io/2025/04/09/bangbang_protect_1/#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%83%A8%E5%88%86\n",
  "wordCount" : "3951",
  "inLanguage": "zh",
  "datePublished": "2025-07-08T10:52:17+08:00",
  "dateModified": "2025-07-08T10:52:17+08:00",
  "author":[{
    "@type": "Person",
    "name": "simpson"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://SimpsonGet.github.io/zh/posts/tech/bangbnagjiagu/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Simpson's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://SimpsonGet.github.io/img/logo.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://SimpsonGet.github.io/zh/" accesskey="h" title="Simpson&#39;s Blog (Alt + H)">Simpson&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://SimpsonGet.github.io/zh/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://SimpsonGet.github.io/zh/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://SimpsonGet.github.io/zh/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://SimpsonGet.github.io/zh/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://SimpsonGet.github.io/zh/">主页</a>&nbsp;»&nbsp;<a href="https://SimpsonGet.github.io/zh/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://SimpsonGet.github.io/zh/posts/tech/">Tech</a></div>
    <h1 class="post-title entry-hint-parent">
      梆梆加固免费壳分析
    </h1>
    <div class="post-description">
      比较水水，很大部分是更着其他人的博客分析了一边其检测，关于解密和加载dex的部分没看
    </div>
    <div class="post-meta"><span title='2025-07-08 10:52:17 +0800 CST'>2025-07-08</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;simpson

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#java%e5%b1%82%e5%88%86%e6%9e%90" aria-label="java层分析">java层分析</a></li>
                <li>
                    <a href="#native%e5%b1%82%e5%88%86%e6%9e%90" aria-label="native层分析">native层分析</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e8%a7%a3%e5%af%86%e5%90%8e%e7%9a%84so%e6%96%87%e4%bb%b6" aria-label="获取解密后的so文件">获取解密后的so文件</a></li>
                <li>
                    <a href="#%e5%88%86%e6%9e%90" aria-label="分析">分析</a><ul>
                        
                <li>
                    <a href="#libc%e7%ac%a6%e5%8f%b7%e8%a1%a8%e6%81%a2%e5%a4%8d" aria-label="libc符号表恢复">libc符号表恢复</a></li>
                <li>
                    <a href="#sub_52bc4%e6%a3%80%e6%b5%8bfrida" aria-label="【sub_52BC4】检测frida">【sub_52BC4】检测frida</a></li>
                <li>
                    <a href="#sub_4cb6c%e7%8e%af%e5%a2%83%e6%a3%80%e6%b5%8b" aria-label="【sub_4CB6C】环境检测">【sub_4CB6C】环境检测</a></li>
                <li>
                    <a href="#sub_52ea0java%e5%b1%82%e6%a3%80%e6%b5%8b" aria-label="【sub_52EA0】java层检测">【sub_52EA0】java层检测</a></li>
                <li>
                    <a href="#sub_4d638hook%e6%a1%86%e6%9e%b6%e6%a3%80%e6%b5%8b" aria-label="【sub_4D638】hook框架检测">【sub_4D638】hook框架检测</a></li>
                <li>
                    <a href="#sub_4e308%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%a3%80%e6%b5%8b" aria-label="【sub_4E308】虚拟机检测">【sub_4E308】虚拟机检测</a></li>
                <li>
                    <a href="#sub_56c10%e8%b0%83%e8%af%95%e5%99%a8%e6%a3%80%e6%b5%8b" aria-label="【sub_56C10】调试器检测">【sub_56C10】调试器检测</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%af%86dex" aria-label="【解密DEX】">【解密DEX】</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae" aria-label="参考文献">参考文献</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><!-- more -->
<hr>
<p>样本：超星学习通[v6.5.9]</p>
<p>包名：com.chaoxing.mobile</p>
<hr>
<h2 id="java层分析">java层分析<a hidden class="anchor" aria-hidden="true" href="#java层分析">#</a></h2>
<p>梆梆加固特征</p>
<p><img alt="image-20250706105017905" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706105017905.png"></p>
<p>程序入口点</p>
<p><img alt="image-20250706105239305" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706105239305.png"></p>
<p><img alt="image-20250706105259834" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706105259834.png"></p>
<p>根据系统架构选择</p>
<p><img alt="image-20250706105531380" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706105531380.png"></p>
<p><img alt="image-20250706105543581" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706105543581.png"></p>
<p>在load()函数后，使用doAttach()利用反射的手段调用代码，那么libDexHelper.so即为对原始dex文件的释放</p>
<h2 id="native层分析">native层分析<a hidden class="anchor" aria-hidden="true" href="#native层分析">#</a></h2>
<hr>
<p>so文件：libDexHelper.so</p>
<hr>
<p>直接打开apk中的so文件，可以发现so文件被加密</p>
<p><img alt="image-20250706110148997" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706110148997.png"></p>
<p><img alt="image-20250706110340401" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706110340401.png"></p>
<h3 id="获取解密后的so文件">获取解密后的so文件<a hidden class="anchor" aria-hidden="true" href="#获取解密后的so文件">#</a></h3>
<p>dump解密so文件的时机</p>
<p>博文给出的是在android_dlopen_ext时机</p>
<p>dump的逻辑是修改目标段的读写执行权限，再将内存读到缓冲区，写入目标地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hook_dlopen</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">soName</span> <span class="o">=</span> <span class="s2">&#34;libDexHelper.so&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;android_dlopen_ext&#39;</span><span class="p">),{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onEnter</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//arg[0] 是要加载的so的路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="kd">let</span> <span class="nx">loadPath</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">readUtf8String</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dlopen call is: &#34;</span> <span class="o">+</span> <span class="nx">loadPath</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">loadPath</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">soName</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="nx">flag</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span><span class="nx">onLeave</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">retval</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dlopen return\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">flag</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">                <span class="nx">dumpSo</span><span class="p">(</span><span class="nx">soName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">flag</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">dumpSo</span><span class="p">(</span><span class="nx">filename</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">getModuleByName</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[dump] start dumping ---------&#34;</span> <span class="o">+</span> <span class="nx">handle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="s2">&#34;/data/data/com.chaoxing.mobile/&#34;</span> <span class="o">+</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34;_&#34;</span> <span class="o">+</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="s2">&#34;_&#34;</span> <span class="o">+</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.so&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">file_handle</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">file_handle</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[dump] dump failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Memory</span><span class="p">.</span><span class="nx">protect</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">base</span><span class="p">),</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="s1">&#39;rwx&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">libbuffer</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">base</span><span class="p">).</span><span class="nx">readByteArray</span><span class="p">(</span><span class="nx">handle</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_handle</span><span class="p">.</span><span class="nx">webkitRelativePath</span><span class="p">(</span><span class="nx">libbuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_handle</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[dump] dump finished and path is: &#34;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">setImmediate</span><span class="p">(</span><span class="nx">hook_dlopen</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250706112917728" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706112917728.png"></p>
<p>内存中dump下来的so文件需要进行修复，这里使用sofixer修复</p>
<p><img alt="image-20250706113332148" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706113332148.png"></p>
<p><img alt="image-20250706114348970" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706114348970.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sofixer  -s soruce.so -o fix.so -m 0x0 -d 
</span></span><span class="line"><span class="cl">-s 待修复的so路径
</span></span><span class="line"><span class="cl">-o 修复后的so路径
</span></span><span class="line"><span class="cl">-m 內存dump的基地址<span class="o">(</span>16位<span class="o">)</span> 0xABC
</span></span><span class="line"><span class="cl">-d 输出debug信息
</span></span></code></pre></td></tr></table>
</div>
</div><p>修复后</p>
<p><img alt="image-20250706133733314" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706133733314.png"></p>
<p>还有一些函数名被混淆，用idapython恢复为sub_offset</p>
<p><img alt="image-20250706133756733" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706133756733.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rename_function</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">func_ea</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">funcName</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func_ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">funcName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;pS&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">funcName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;j_&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">funcName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;p5&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">editName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;sub_</span><span class="si">{</span><span class="n">func_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">func_ea</span><span class="p">,</span> <span class="n">editName</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">SN_NOWARN</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Success] </span><span class="si">{</span><span class="n">funcName</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="n">editName</span><span class="si">}</span><span class="s2"> in (0x</span><span class="si">{</span><span class="n">func_ea</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rename_function</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250706135107295" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706135107295.png"></p>
<h3 id="分析">分析<a hidden class="anchor" aria-hidden="true" href="#分析">#</a></h3>
<p>JNI_Onload中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">com/secneo/apkwrapper/H
</span></span><span class="line"><span class="cl">(Ljava/lang/String;)I
</span></span><span class="line"><span class="cl">(Ljava/lang/String;I)V
</span></span><span class="line"><span class="cl">(I)V
</span></span><span class="line"><span class="cl">(Ljava/lang/String;)Ljava/lang/String;  d
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">com/secneo/apkwrapper/AW
</span></span><span class="line"><span class="cl">()V   pn
</span></span><span class="line"><span class="cl">(Landroid/content/Context;Landroid/app/Application;)V    hn
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>sub_3199C函数集合了各种检测</strong></p>
<p><img alt="image-20250707180645302" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707180645302.png"></p>
<p>有很多跳板函数，需要结合<strong>0x71aeb83000</strong>内存加载地址去跳转</p>
<p><img alt="image-20250706203027823" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706203027823.png"></p>
<p><strong>0x430C0</strong>实现对 <code>libc.so</code> 中 <code>read、open64、openat64</code>等	函数的 hook 或替换。</p>
<p><img alt="image-20250706204436651" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706204436651.png"></p>
<p>sub_52BC4中</p>
<h4 id="libc符号表恢复">libc符号表恢复<a hidden class="anchor" aria-hidden="true" href="#libc符号表恢复">#</a></h4>
<p>一些thunk函数0x7254D05110其实是libc中的</p>
<p>base = 0x7254c9a000</p>
<p><img alt="image-20250706211724494" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706211724494.png"></p>
<ul>
<li>导出libc符号表</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">nm -D libc.so <span class="p">&gt;</span> libc_symbols.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250706212803940" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706212803940.png"></p>
<ul>
<li>导入到libdexhelp中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ida_bytes</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="mh">0x7254c9a000</span>  <span class="c1"># /proc/pid/maps/   获得</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_symbols</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./libc_symbols.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 去掉版本号</span>
</span></span><span class="line"><span class="cl">            <span class="n">libc_symbols</span><span class="p">[</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 遍历当前段中的 qword</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Segments</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">segname</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;.data&#39;</span> <span class="ow">in</span> <span class="n">segname</span> <span class="ow">or</span> <span class="s1">&#39;.got&#39;</span> <span class="ow">in</span> <span class="n">segname</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_segm_start</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">end</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_segm_end</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>  <span class="c1"># 64位系统</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">is_qword</span><span class="p">(</span><span class="n">ida_bytes</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">addr</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">ptr_val</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_qword</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">ptr_val</span> <span class="ow">in</span> <span class="n">libc_symbols</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">libc_symbols</span><span class="p">[</span><span class="n">ptr_val</span><span class="p">]</span><span class="si">}</span><span class="s2">_ptr&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">idc</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">SN_CHECK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[success] edit the </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2"> ---&gt; </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sub_52bc4检测frida">【sub_52BC4】检测frida<a hidden class="anchor" aria-hidden="true" href="#sub_52bc4检测frida">#</a></h4>
<p><img alt="image-20250706214919893" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706214919893.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">//libc部分函数的参数及用法
</span></span><span class="line"><span class="cl">sendto（int sockfd， const void *msg，int len , unsigned int flags， const struct sockaddr *to， int tolen）
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">recvfrom（int sockfd，void *buf，int len，unsigned int lags，struct sockaddr *from，int *fromlen
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">access(const char* pathname, int mode)
</span></span><span class="line"><span class="cl">//检查调用进程是否能对pathname指定的文件作mode操作，成功执行返回0，失败为-1
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qword_EDE40  =
</span></span><span class="line"><span class="cl">GET/ws HTTP/1.1
</span></span><span class="line"><span class="cl">Upgrade: websocket
</span></span><span class="line"><span class="cl">Connection: Upgrade
</span></span><span class="line"><span class="cl">Sec-WebSocket-Key: nmmA32Q10Aqj2vWK
</span></span><span class="line"><span class="cl">w==
</span></span><span class="line"><span class="cl">Sec-WebSocket-Version: 13
</span></span><span class="line"><span class="cl">Host: 127.0.0.1:27042
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250706223027133" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706223027133.png"></p>
<p><img alt="image-20250706224856634" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706224856634.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">v16[0] = 2; 
</span></span><span class="line"><span class="cl">//这个赋值操作看起来像是设置某个协议族（family）。
</span></span><span class="line"><span class="cl">在常见的网络编程中，AF_INET 的值是 2，表示 IPv4 地址族。因此，这可能是在初始化一个 sockaddr_in 结构体的第一个字段 sin_family。
</span></span><span class="line"><span class="cl">v4 = 20000; 这个变量 v4 被设置为 20000。考虑到后续的操作，这个值很可能是用于设置端口号。
</span></span><span class="line"><span class="cl">v16[1] = bswap32(v4) &gt;&gt; 16; 这里对 v4 进行了字节交换 (bswap32) 并右移 16 位。字节交换通常用于处理不同字节序之间的转换（例如，从主机字节序到网络字节序）。假设 bswap32(v4) 将 v4 的字节顺序反转，对于值 20000（即十六进制的 0x4E20），其字节交换后的结果仍然是 0x4E20（因为它是32位整数，且高位字节为零）。然后将其右移16位，得到的结果是 0x0000。
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据27042端口，即 本地的 Frida Server 默认监听端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">这段代码的行为
</span></span><span class="line"><span class="cl">用 AUTH\r\n 探测服务是否开启
</span></span><span class="line"><span class="cl">发送标准 WebSocket 请求到 127.0.0.1:27042，分析是否返回 Sec-WebSocket-Accept，判断 WebSocket 是否被接受
</span></span><span class="line"><span class="cl">如果成功，说明本地 Frida 正在运行，被识别
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sub_4cb6c环境检测">【sub_4CB6C】环境检测<a hidden class="anchor" aria-hidden="true" href="#sub_4cb6c环境检测">#</a></h4>
<p><img alt="image-20250706231952403" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250706231952403.png"><img alt="image-20250707120543624" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707120543624.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">xmmword_C4200</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">v37_a</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="o">-</span><span class="n">num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">common</span><span class="p">(</span><span class="n">oldstr</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp2</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">+=</span> <span class="n">oldstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oldstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp2</span> <span class="o">=</span> <span class="n">oldstr</span><span class="p">[</span><span class="mi">17</span><span class="p">::]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">oldstr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">xmmword_C4200</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oldstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">tmp2</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tmp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">v37_1</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">v37</span> <span class="o">=</span>  <span class="s2">&#34;0uejp2/ersg2ed011pbiltm1ed&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a0uejp2Ersg2ed0</span> <span class="o">=</span> <span class="s2">&#34;0uejp2/ersg2ed011pbiltm1ed&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[17], 3)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[18] ,1)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[19] , 2)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[20] , 3)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[21] , 1)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[22] , 2)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[23] , 3)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[24] , 1)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># a(a0uejp2Ersg2ed0[25] , 2)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v37</span> <span class="o">=</span> <span class="s2">&#34;/uejp2/ersg2ed011magisk.db&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v37</span> <span class="o">=</span> <span class="n">common</span><span class="p">(</span><span class="n">v37</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">v37</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">v45_1</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">v45</span> <span class="o">=</span> <span class="s2">&#34;0uejp2/ersg2nkusqr&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v45</span> <span class="o">=</span> <span class="s2">&#34;/uejp2/ersg2nkusqr&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v45</span> <span class="o">=</span> <span class="n">common</span><span class="p">(</span><span class="n">v45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">v45</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">v50_1</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">v50</span> <span class="o">=</span>  <span class="s2">&#34;0u|tvhn1ejp2ncjjuk&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v50</span> <span class="o">=</span> <span class="s2">&#34;/u|tvhn1ejp2ncjjuk&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">v50</span> <span class="o">=</span> <span class="n">common</span><span class="p">(</span><span class="n">v50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">v50</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v37 === &#34;</span><span class="p">,</span><span class="n">v37_1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v45 === &#34;</span><span class="p">,</span><span class="n">v45_1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;v50 === &#34;</span><span class="p">,</span><span class="n">v50_1</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">/sbin/.core/db-0/magisk.db   .core是使用的隐藏目录，包含其核心运行时数据。数据库存储设置和root权限
</span></span><span class="line"><span class="cl">/sbin/.core/mirror		是 Magisk 的一个关键功能 —— system-as-root 镜像挂载点		
</span></span><span class="line"><span class="cl">/system/bin/magisk	是主程序
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/system/usr/we-need-root/
</span></span><span class="line"><span class="cl">/system/bin/failsafe/
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过一些字符串的拼接解密获得文件路径，然后使用<strong>access函数</strong>判断</p>
<p>1、/sbin/.core/mirror</p>
<p>2、/data/local/su</p>
<p>3、/data/local/bin/su</p>
<p>4、 /data/local/xbin/su</p>
<p>5、/sbin/su</p>
<p>6、/su/bin/su</p>
<p>7、/system/bin/su</p>
<p>8、/system/bin/.ext/su</p>
<p>9、/system/bin/failsafe/su</p>
<p>10、/system/sd/xbin/su</p>
<p>11、/system/usr/we-need-root/su</p>
<p>12、/system/xbin/su</p>
<p>调用 openat 中断访问/proc/self/attr/prev文件获取数值与字符串u:r:zygote:s0比对调用</p>
<p><strong>SELinux 上下文（SELinux Context）检测</strong>，用于判断当前进程是否运行在预期的安全上下文中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">user:role:type:sensitivity
</span></span><span class="line"><span class="cl">u:r:zygote:s0 → zygote 进程的安全上下文
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/proc/self/attr/prev 是什么？
</span></span><span class="line"><span class="cl">这是 SELinux 提供的一个接口文件，表示 当前进程的上一个安全上下文
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">正常情况下，App 是由 Zygote 启动的，它的 prev 上下文是 u:r:zygote:s0
</span></span><span class="line"><span class="cl">如果修改了启动方式，比如通过 su 提权后再启动这个 App，那么 prev 上下文就会变成 u:r:su:s0 或其他非 zygote 上下文
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250707121037839" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707121037839.png"></p>
<p><code>ro.build.tags</code> 主要用于标识构建类型如果检测到 <code>test-keys</code> 而不是 <code>release-keys</code>，则可能提示用户当前系统存在潜在的安全问题。</p>
<p><img alt="image-20250707121143659" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707121143659.png"></p>
<h4 id="sub_52ea0java层检测">【sub_52EA0】java层检测<a hidden class="anchor" aria-hidden="true" href="#sub_52ea0java层检测">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">int pthread_create(pthread_t *thread,
</span></span><span class="line"><span class="cl">                   const pthread_attr_t *attr,
</span></span><span class="line"><span class="cl">                   void *(*start_routine) (void *),
</span></span><span class="line"><span class="cl">                   void *arg);
</span></span><span class="line"><span class="cl">//\3) void *(*start_routine) (void *)：以函数指针的方式指明新建线程需要执行的函数，该函数的参数最多有 1 个（可以省略不写），形参和返回值的类型都必须为 void* 类型。void* 类型又称空指针类型，表明指针所指数据的类型是未知的。使用此类型指针时，我们通常需要先对其进行强制类型转换，然后才能正常访问指针指向的数据。
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据pthread_create函数的使用方法得x2寄存器存放的sub_52EA0函数，其实是将要开启新线程执行的函数地址</p>
<p><img alt="image-20250707160445295" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707160445295.png"></p>
<p>线程异步执行sub_52EA0</p>
<p>这边需要根据汇编手动恢复该函数的签名（因为是thunk跳板函数所以ida没有自动识别），也可以使用idapython去做自动化批量设置</p>
<p><img alt="image-20250707160858409" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707160858409.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl"> j_execl_ptr(&#34;/system/bin/app_process&#34;, &#34;/system/bin/app_process&#34;, &#34;/system/bin&#34;, “--nice-name=zygisk.so”, &#34;com.secneo.apkwrapper.H&#34;, &#34;--write-fd&#34;, v12, &#34;--flags&#34;, 0, 0LL);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250707165132755" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707165132755.png"></p>
<p>so层通过excel对java层进行检测，检测tracepid</p>
<p>​	<img alt="image-20250707165606851" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707165606851.png"></p>
<h4 id="sub_4d638hook框架检测">【sub_4D638】hook框架检测<a hidden class="anchor" aria-hidden="true" href="#sub_4d638hook框架检测">#</a></h4>
<p>太多了就恢复两个看看</p>
<p><img alt="image-20250707180123836" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707180123836.png"></p>
<p>isExportFunctionExist是对目标so以绝对路径的方式</p>
<p>通过mmap进行映射到maps中，与原来已经在maps的so在内存中的导出函数进行<strong>比对前16个字节</strong>，</p>
<p>如果比对不一致则返回1，否则返回0，如果maps没有这个so则返回0，如果maps中有这个so但没有这个要搜索的导出函数则返回-1。</p>
<p><img alt="image-20250707174207789" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707174207789.png"></p>
<p>通过对比libart.so中导出函数的前16字节判断是否被修改。</p>
<p><img alt="image-20250707180538384" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707180538384.png"></p>
<p>检查环境变量 <code>CLASSPATH</code> 是否存在、是否非空、且是否长度大于等于 6。为了判断当前运行环境是否被注入、是否正确设置、是否伪装成功等。</p>
<h4 id="sub_4e308虚拟机检测">【sub_4E308】虚拟机检测<a hidden class="anchor" aria-hidden="true" href="#sub_4e308虚拟机检测">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">在Android开发中，可以通过c接口直接获取设备属性，系统接口为：
</span></span><span class="line"><span class="cl">int __system_property_get(const char* name, char* value)；
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;ro.bluetooth.name&#34;, a1)
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;vmos.browser.home&#34;, a1)
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;vmprop.wifissid&#34;, a1)
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;ro.product.manufacturer&#34;, a1)
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;ro.product.model&#34;, a1)
</span></span><span class="line"><span class="cl">j___system_property_get_ptr(&#34;ro.product.manufacturer&#34;, a1)
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250707215501006" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707215501006.png"></p>
<p>ueventd.ttVM_x86.rc、init.ttVM_x86.rc这些是 <strong>BlueStacks 虚拟机镜像文件</strong>，一般不会在真实设备中出现。</p>
<p>判断这些文件是否存在且是普通文件，	 关键字判断等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">#其他博客的总结
</span></span><span class="line"><span class="cl">调用 _system_property_get(&#34;ro.bluetooth.name&#34;, resultAddr) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              ro.ip.name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              ro.product.manufacturer         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              ro.product.model
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这么四个属性对应的数值与&#34;vmos&#34;（&#34;vmos&#34;代表虚拟机）比较 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">调用 _system_property_get(&#34;vmos.browser.home&#34;, resultAddr) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              vmos.camera.enable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              ro.vmos.simplest.rom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              persist.vmos.setting.show
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              persist.vmos.tool.show
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这么四个属性对应的数值与0x30作比较（满足一定的条件resultAddr会被自动赋值为0x30）比较，此处是比较不相同
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">调用 _system_property_get(&#34;vmprop.wifissid&#34;, resultAddr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">调用 _system_property_get(&#34;persist.vmos.root.enable&#34;, resultAddr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">调用 _system_property_get(&#34;persist.vmos.root.show&#34;, resultAddr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              persist.vmos.skills.show
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              persist.vmos.xposed.enable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              persist.vmos.xposed.show
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              ro.vmos.simplest.rom
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              vmos.camera.enable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">上述调用_system_property_get获取属性值之后，如果_system_property_get的返回值是否大于0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">调用 access 访问 /system/priv-app/vmos-pro-intent 是否存在
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fopen 打开 //proc/version.osed.show 文件，调用fgets获取文件内容，是否存在字符串&#34;titan&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fopen 打开 //property_contexts.show 文件，调用fgets获取文件内容，是否存在字符串&#34;titan&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">fopen 打开 //service_contexts 文件，调用fgets获取文件内容，是否存在字符串&#34;titan&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sub_56c10调试器检测">【sub_56C10】调试器检测<a hidden class="anchor" aria-hidden="true" href="#sub_56c10调试器检测">#</a></h4>
<p><img alt="image-20250707220529453" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707220529453.png"></p>
<p>通过foepn 打开/proc/pid/status文件</p>
<p>调用sleep(1)循环检查status文件检测“<strong>state</strong>”标志和&quot;<strong>TracerPid:</strong>&ldquo;标志</p>
<p>如果获取的pid不为0且跟调用getpid函数获取自身pid的<strong>不一致</strong>则调用中断 kill 关闭调试进程</p>
<p><img alt="image-20250707220617802" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707220617802.png"></p>
<p><img alt="image-20250707221137436" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707221137436.png"></p>
<h4 id="解密dex">【解密DEX】<a hidden class="anchor" aria-hidden="true" href="#解密dex">#</a></h4>
<p><img alt="image-20250707222657087" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707222657087.png"></p>
<p>加密数据存放于最大的dex中，根据dexdata0定位</p>
<p><img alt="image-20250707222841856" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707222841856.png"></p>
<p>每次申请0x20000大小循环解密</p>
<p><img alt="image-20250707223212286" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707223212286.png"></p>
<p>sub_38E04</p>
<p>三个参数分别是：被加密数据的地址、存放解密后数据的位置、参与解密运算的32字节密钥</p>
<p><img alt="image-20250707222939204" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707222939204.png"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">makeInMemoryDexElements 的核心作用是：
</span></span><span class="line"><span class="cl">将内存中的 DEX 文件（或 ZIP/APK 中的 DEX）转换为 DexPathList 中的 Element 数组，供 ClassLoader 使用。
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image-20250707223344097" loading="lazy" src="/zh/posts/tech/bangbnagjiagu/image-20250707223344097.png"></p>
<p>最后使用dexfile::loader加载解密后的dex文件</p>
<h2 id="参考文献">参考文献<a hidden class="anchor" aria-hidden="true" href="#参考文献">#</a></h2>
<p><a href="https://bbs.kanxue.com/thread-191649.htm">https://bbs.kanxue.com/thread-191649.htm</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/685239153">https://zhuanlan.zhihu.com/p/685239153</a></p>
<p><a href="https://x2d1.github.io/2025/04/09/bangbang_protect_1/#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%83%A8%E5%88%86">https://x2d1.github.io/2025/04/09/bangbang_protect_1/#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%83%A8%E5%88%86</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://SimpsonGet.github.io/zh/tags/android/">Android</a></li>
      <li><a href="https://SimpsonGet.github.io/zh/tags/shell/">Shell</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://SimpsonGet.github.io/zh/posts/read/owasp/">
    <span class="title">« 上一页</span>
    <br>
    <span>Owasp Tpo 10 学习</span>
  </a>
  <a class="next" href="https://SimpsonGet.github.io/zh/posts/tech/xhsunwatermark/">
    <span class="title">下一页 »</span>
    <br>
    <span>x红书水印去除</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://SimpsonGet.github.io/zh/">Simpson&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
